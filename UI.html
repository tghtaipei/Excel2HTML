<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      padding: 20px;
      background-color: #f5f7fa;
    }
    
    .container {
      max-width: 100%;
    }
    
    h2 {
      color: #1a73e8;
      font-size: 20px;
      margin-bottom: 10px;
      font-weight: 600;
    }
    
    .subtitle {
      color: #5f6368;
      font-size: 13px;
      margin-bottom: 20px;
      line-height: 1.6;
    }
    
    .upload-area {
      background: white;
      border: 2px dashed #dadce0;
      border-radius: 8px;
      padding: 30px 20px;
      text-align: center;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .upload-area:hover {
      border-color: #1a73e8;
      background-color: #f8f9fa;
    }
    
    .upload-area.dragover {
      border-color: #1a73e8;
      background-color: #e8f0fe;
    }
    
    .upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    .upload-text {
      color: #5f6368;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .file-input-label {
      display: inline-block;
      padding: 10px 24px;
      background: #1a73e8;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.3s;
    }
    
    .file-input-label:hover {
      background: #1557b0;
    }
    
    .file-input {
      display: none;
    }
    
    .file-info {
      margin-top: 15px;
      padding: 10px;
      background: #e8f0fe;
      border-radius: 4px;
      font-size: 13px;
      color: #1a73e8;
      display: none;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #1a73e8;
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #1557b0;
      box-shadow: 0 2px 4px rgba(26, 115, 232, 0.4);
    }
    
    .btn-danger {
      background: #ea4335;
      color: white;
    }
    
    .btn-danger:hover:not(:disabled) {
      background: #d33828;
      box-shadow: 0 2px 4px rgba(234, 67, 53, 0.4);
    }
    
    .status-box {
      background: white;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }
    
    .status-box.show {
      display: block;
    }
    
    .status-title {
      font-weight: 600;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .status-content {
      font-size: 13px;
      line-height: 1.8;
      color: #5f6368;
    }
    
    .status-success {
      border-left: 4px solid #34a853;
    }
    
    .status-success .status-title {
      color: #34a853;
    }
    
    .status-error {
      border-left: 4px solid #ea4335;
    }
    
    .status-error .status-title {
      color: #ea4335;
    }
    
    .status-info {
      border-left: 4px solid #1a73e8;
    }
    
    .status-info .status-title {
      color: #1a73e8;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .loading.show {
      display: block;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1a73e8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #5f6368;
      font-size: 14px;
    }
    
    .info-box {
      background: #e8f0fe;
      border-left: 4px solid #1a73e8;
      padding: 12px;
      border-radius: 4px;
      margin-top: 15px;
      font-size: 12px;
      color: #1a73e8;
      line-height: 1.6;
    }

    .meta-card {
      background: #ffffff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      margin-bottom: 15px;
      border: 1px solid #e0e3eb;
    }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .meta-label {
      color: #5f6368;
      font-weight: 600;
    }

    .meta-value {
      color: #1a73e8;
      text-align: right;
    }

    .meta-links a {
      color: #1a73e8;
      text-decoration: none;
      font-weight: 500;
    }

    .meta-links a + a::before {
      content: ' Â· ';
      color: #5f6368;
      font-weight: normal;
    }
    
    .detail-list {
      margin-top: 8px;
      padding-left: 20px;
    }
    
    .detail-list li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“‹ é•·ç…§ç‰¹ç´„å–®ä½åŒ¯å…¥ç³»çµ±</h2>
    <p class="subtitle">
      ä¸Šå‚³Excelæª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•è§£æä¸¦ç”Ÿæˆå¯æœå°‹çš„HTMLé é¢<br>
      æ”¯æ´æ ¼å¼ï¼š.xlsxã€.xls
    </p>

    <div class="meta-card">
      <div class="meta-row">
        <span class="meta-label">ç¨‹å¼ç‰ˆæœ¬</span>
        <span class="meta-value" id="appVersion">è®€å–ä¸­...</span>
      </div>
      <div class="meta-row" style="align-items: flex-start;">
        <span class="meta-label">æœ€æ–°TXTæª”æ¡ˆ</span>
        <div class="meta-value" id="latestFileInfo" style="text-align: right;">è®€å–ä¸­...</div>
      </div>
    </div>
    
    <!-- ä¸Šå‚³å€åŸŸ -->
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">ğŸ“</div>
      <div class="upload-text">
        é»æ“Šé¸æ“‡æª”æ¡ˆæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤è™•
      </div>
      <label for="fileInput" class="file-input-label">
        é¸æ“‡Excelæª”æ¡ˆ
      </label>
      <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
      <div class="file-info" id="fileInfo"></div>
    </div>
    
    <!-- æŒ‰éˆ•çµ„ -->
    <div class="button-group">
      <button class="btn btn-primary" id="importBtn" onclick="importFile()" disabled>
        ğŸ”„ é–‹å§‹åŒ¯å…¥
      </button>
      <button class="btn btn-danger" id="clearBtn" onclick="clearAllData()">
        ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™
      </button>
    </div>
    
    <!-- è¼‰å…¥ä¸­ -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <div class="loading-text">è™•ç†ä¸­ï¼Œè«‹ç¨å€™...</div>
    </div>
    
    <!-- ç‹€æ…‹é¡¯ç¤º -->
    <div class="status-box" id="statusBox"></div>
    
    <!-- èªªæ˜ -->
    <div class="info-box">
      <strong>ğŸ’¡ ä½¿ç”¨èªªæ˜ï¼š</strong>
      <ul class="detail-list">
        <li>æ”¯æ´ã€Œè‡ºåŒ—å¸‚é•·ç…§2.0ç‰¹ç´„å–®ä½ä¸€è¦½è¡¨ã€æ ¼å¼</li>
        <li>ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥åˆ†é æ ¼å¼ä¸¦è§£æ</li>
        <li>ç”Ÿæˆçš„HTMLåŒ…å«åˆ†é åˆ‡æ›ã€æœå°‹ã€ç¯©é¸åŠŸèƒ½</li>
        <li>HTMLæ¡ç”¨iframeæ ¼å¼ï¼Œå¯ç›´æ¥åµŒå…¥ç¶²é </li>
        <li>æª”æ¡ˆå¤§å°é™åˆ¶ï¼š10MB</li>
      </ul>
    </div>
  </div>
  
  <script>
    let selectedFile = null;

    initAppMetadata();
    
    // æª”æ¡ˆé¸æ“‡è™•ç†
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        handleFileSelect(file);
      }
    });
    
    // æ‹–æ›³ä¸Šå‚³
    const uploadArea = document.getElementById('uploadArea');
    
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadArea.classList.remove('dragover');
      
      const file = e.dataTransfer.files[0];
      if (file) {
        handleFileSelect(file);
      }
    });
    
    // è™•ç†æª”æ¡ˆé¸æ“‡
    function handleFileSelect(file) {
      // æª¢æŸ¥æª”æ¡ˆé¡å‹
      const validTypes = [
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      ];
      
      if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls)$/i)) {
        showStatus('error', 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'è«‹é¸æ“‡Excelæª”æ¡ˆï¼ˆ.xlsx æˆ– .xlsï¼‰');
        return;
      }
      
      // æª¢æŸ¥æª”æ¡ˆå¤§å°ï¼ˆ10MBï¼‰
      if (file.size > 10 * 1024 * 1024) {
        showStatus('error', 'æª”æ¡ˆå¤ªå¤§', 'æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é10MB');
        return;
      }
      
      selectedFile = file;
      
      // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
      const fileInfo = document.getElementById('fileInfo');
      const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
      fileInfo.innerHTML = `
        ğŸ“„ å·²é¸æ“‡ï¼š${file.name}<br>
        ğŸ“¦ å¤§å°ï¼š${fileSizeMB} MB
      `;
      fileInfo.style.display = 'block';
      
      // å•Ÿç”¨åŒ¯å…¥æŒ‰éˆ•
      document.getElementById('importBtn').disabled = false;
      
      // æ¸…é™¤ä¹‹å‰çš„ç‹€æ…‹
      document.getElementById('statusBox').classList.remove('show');
    }
    
    // åŒ¯å…¥æª”æ¡ˆ
    function importFile() {
      if (!selectedFile) {
        showStatus('error', 'æœªé¸æ“‡æª”æ¡ˆ', 'è«‹å…ˆé¸æ“‡è¦åŒ¯å…¥çš„Excelæª”æ¡ˆ');
        return;
      }
      
      // é¡¯ç¤ºè¼‰å…¥ä¸­
      document.getElementById('loading').classList.add('show');
      document.getElementById('importBtn').disabled = true;
      document.getElementById('clearBtn').disabled = true;
      document.getElementById('statusBox').classList.remove('show');
      
      // è®€å–æª”æ¡ˆ
      const reader = new FileReader();
      
      reader.onload = function(e) {
        const fileData = {
          name: selectedFile.name,
          mimeType: selectedFile.type,
          data: e.target.result.split(',')[1] // Base64ç·¨ç¢¼
        };
        
        // å‘¼å«å¾Œç«¯è™•ç†
        google.script.run
          .withSuccessHandler(onImportSuccess)
          .withFailureHandler(onImportError)
          .processExcelFile(fileData);
      };
      
      reader.onerror = function() {
        onImportError('æª”æ¡ˆè®€å–å¤±æ•—');
      };
      
      reader.readAsDataURL(selectedFile);
    }
    
    // åŒ¯å…¥æˆåŠŸ
    function onImportSuccess(result) {
      document.getElementById('loading').classList.remove('show');
      document.getElementById('importBtn').disabled = false;
      document.getElementById('clearBtn').disabled = false;
      
      if (result.success) {
        let detailsHtml = '<ul class="detail-list">';
        detailsHtml += `<li>åˆ†é æ•¸ï¼š${result.details.åˆ†é æ•¸}</li>`;
        detailsHtml += `<li>ç¸½æ©Ÿæ§‹æ•¸ï¼š${result.details.ç¸½æ©Ÿæ§‹æ•¸}</li>`;
        detailsHtml += `<li>è™•ç†æ™‚é–“ï¼š${result.details.è™•ç†æ™‚é–“}</li>`;
        detailsHtml += '<li>åˆ†é åˆ—è¡¨ï¼š<ul>';
        result.details.åˆ†é åˆ—è¡¨.forEach(function(sheet) {
          detailsHtml += `<li>${sheet}</li>`;
        });
        detailsHtml += '</ul></li>';
        detailsHtml += '</ul>';
        
        showStatus('success', 'âœ… åŒ¯å…¥æˆåŠŸï¼', 
          'è³‡æ–™å·²æˆåŠŸå¯«å…¥Google Sheet<br>' + detailsHtml);
      } else {
        showStatus('error', 'åŒ¯å…¥å¤±æ•—', result.message + '<br>' + (result.error || ''));
      }
    }
    
    // åŒ¯å…¥å¤±æ•—
    function onImportError(error) {
      document.getElementById('loading').classList.remove('show');
      document.getElementById('importBtn').disabled = false;
      document.getElementById('clearBtn').disabled = false;
      
      showStatus('error', 'è™•ç†éŒ¯èª¤', error.message || error.toString());
    }
    
    // æ¸…é™¤æ‰€æœ‰è³‡æ–™
    function clearAllData() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
        return;
      }
      
      document.getElementById('loading').classList.add('show');
      document.getElementById('clearBtn').disabled = true;
      
      google.script.run
        .withSuccessHandler(function() {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('clearBtn').disabled = false;
          showStatus('success', 'æ¸…é™¤æˆåŠŸ', 'æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤');
          
          // é‡ç½®æª”æ¡ˆé¸æ“‡
          selectedFile = null;
          document.getElementById('fileInput').value = '';
          document.getElementById('fileInfo').style.display = 'none';
          document.getElementById('importBtn').disabled = true;
        })
        .withFailureHandler(function(error) {
          document.getElementById('loading').classList.remove('show');
          document.getElementById('clearBtn').disabled = false;
          showStatus('error', 'æ¸…é™¤å¤±æ•—', error.message || error.toString());
        })
        .clearData();
    }
    
    // é¡¯ç¤ºç‹€æ…‹
    function showStatus(type, title, content) {
      const statusBox = document.getElementById('statusBox');
      statusBox.className = 'status-box show status-' + type;
      statusBox.innerHTML = `
        <div class="status-title">${title}</div>
        <div class="status-content">${content}</div>
      `;
    }

    function initAppMetadata() {
      if (!(typeof google !== 'undefined' && google.script && google.script.run)) {
        document.getElementById('appVersion').textContent = 'åƒ…é™Google Sheetsç’°å¢ƒ';
        document.getElementById('latestFileInfo').textContent = 'è«‹æ–¼Google Sheetså´é‚Šæ¬„æŸ¥çœ‹';
        return;
      }

      google.script.run
        .withSuccessHandler(renderAppMetadata)
        .withFailureHandler(function() {
          document.getElementById('appVersion').textContent = 'ç„¡æ³•å–å¾—ç‰ˆæœ¬';
          document.getElementById('latestFileInfo').textContent = 'ç„¡æ³•è®€å–æª”æ¡ˆè³‡è¨Š';
        })
        .getAppMetadata();
    }

    function renderAppMetadata(data) {
      document.getElementById('appVersion').textContent = data && data.version ? data.version : 'æœªçŸ¥';

      const infoEl = document.getElementById('latestFileInfo');

      if (data && data.latestFile) {
        infoEl.innerHTML = `
          <div>æª”åï¼š${data.latestFile.name}</div>
          <div>æ›´æ–°ï¼š${data.latestFile.updatedAt}</div>
          <div class="meta-links">
            <a href="${data.latestFile.url}" target="_blank">æª¢è¦–æª”æ¡ˆ</a>
            <a href="${data.latestFile.downloadUrl}" target="_blank">ç›´æ¥ä¸‹è¼‰</a>
          </div>
        `;
      } else {
        infoEl.textContent = 'å°šæœªç”¢å‡ºTXTæª”æ¡ˆ';
      }
    }
  </script>
</body>
</html>
