<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Arial, "Microsoft JhengHei", sans-serif;
      padding: 0;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      padding: 25px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .header h1 {
      margin: 0;
      font-size: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    

    .container {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
    }
    
    .drop-zone {
      border: 3px dashed rgba(255, 255, 255, 0.5);
      border-radius: 15px;
      padding: 50px 30px;
      text-align: center;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }
    
    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.02);
    }
    
    .drop-zone-icon {
      font-size: 60px;
      margin-bottom: 15px;
      opacity: 0.8;
    }
    
    .drop-zone-text {
      color: white;
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .drop-zone-hint {
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }
    
    .button-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    button {
      padding: 16px 24px;
      font-size: 16px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    
    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    button:hover::before {
      width: 300px;
      height: 300px;
    }
    
    button span {
      position: relative;
      z-index: 1;
    }
    
    .import-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }
    
    .import-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(245, 87, 108, 0.4);
    }
    
    .clear-btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }
    
    .clear-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
    }
    
    .status {
      margin-top: 20px;
      padding: 15px 20px;
      border-radius: 12px;
      display: none;
      font-size: 14px;
      font-weight: 600;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .status.success {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      color: #2e7d32;
      border: 2px solid #66bb6a;
    }
    
    .status.error {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: #c62828;
      border: 2px solid #ef5350;
    }
    
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      text-align: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      border-bottom: 3px solid #667eea;
    }
    
    .spinner {
      border: 4px solid rgba(102, 126, 234, 0.2);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      color: #667eea;
      font-weight: 600;
      font-size: 16px;
    }
    
    input[type="file"] {
      display: none;
    }
    
    .header-input-container {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      max-height: 500px;
      overflow-y: auto;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .header-input-container h3 {
      color: #667eea;
      margin: 0 0 20px 0;
      font-size: 20px;
      font-weight: 700;
    }
    
    .sheet-header-input {
      margin-bottom: 20px;
      padding: 18px;
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.8);
    }
    
    .sheet-header-input h4 {
      margin: 0 0 15px 0;
      color: #d84315;
      font-size: 17px;
      font-weight: 700;
    }
    
    .sheet-header-input label {
      display: block;
      margin-bottom: 10px;
      font-size: 15px;
      color: #bf360c;
      font-weight: 600;
    }
    
    .sheet-header-input input[type="number"] {
      width: 120px;
      padding: 10px 15px;
      border: 3px solid #ff6f00;
      border-radius: 8px;
      font-size: 16px;
      background: white;
      font-weight: 700;
      color: #d84315;
      transition: all 0.3s;
    }
    
    .sheet-header-input input[type="number"]:focus {
      outline: none;
      border-color: #f50057;
      box-shadow: 0 0 0 4px rgba(245, 0, 87, 0.2);
      transform: scale(1.05);
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 15px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .preview-table th,
    .preview-table td {
      border: 1px solid #e0e0e0;
      padding: 8px;
      text-align: left;
    }
    
    .preview-table th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 700;
    }
    
    .preview-table td {
      color: #424242;
    }
    
    .preview-table tr:nth-child(even) {
      background: #f5f5f5;
    }
    
    .confirm-btn {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
      width: 100%;
      margin-top: 15px;
      font-size: 18px;
      padding: 18px;
    }
    
    .confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(56, 239, 125, 0.4);
    }
    
    /* æ»¾å‹•æ¢ç¾åŒ– */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.5);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.7);
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">è™•ç†ä¸­...</div>
  </div>
  
  <div class="header">
    <h1>è¼•é¬†å°‡æ‚¨çš„ Excel è¡¨æ ¼è½‰æ›ç‚ºäº’å‹•å¼ç¶²é </h1>
  </div>
  
  <div class="container">
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-icon">ğŸ“</div>
      <div class="drop-zone-text">æ‹–æ›³ Excel æª”æ¡ˆè‡³æ­¤</div>
      <div class="drop-zone-hint">æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆä¸Šå‚³</div>
    </div>
    
    <input type="file" id="fileInput" accept=".xlsx,.xls">
    
    <div class="button-container">
      <button class="clear-btn" onclick="clearData()">
        <span>ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™</span>
      </button>
    </div>
    
    <div class="header-input-container" id="headerInputContainer"></div>
    
    <div class="status" id="status"></div>
  </div>
  
  <script>
    var currentFileName = '';
    var currentSheets = [];
    
    // æ‹–æ‹‰ä¸Šå‚³åŠŸèƒ½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    
    dropZone.addEventListener('click', () => {
      fileInput.click();
    });
    
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });
    
    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });
    
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });
    
    function selectFile() {
      fileInput.click();
    }
    
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    });
    
    function handleFile(file) {
      if (!file.name.match(/\.(xlsx|xls)$/i)) {
        showStatus('è«‹é¸æ“‡ Excel æª”æ¡ˆ (.xlsx æˆ– .xls)', 'error');
        return;
      }
      
      showLoading('ä¸Šå‚³ä¸¦è§£ææª”æ¡ˆä¸­...');
      
      var reader = new FileReader();
      reader.onload = function(e) {
        var data = e.target.result;
        
        google.script.run
          .withSuccessHandler(onImportSuccess)
          .withFailureHandler(onError)
          .handleImport(data, file.name);
      };
      reader.readAsDataURL(file);
    }
    
    function onImportSuccess(result) {
      hideLoading();
      
      if (!result.success) {
        showStatus(result.message, 'error');
        return;
      }
      
      if (result.needHeaderInput) {
        currentFileName = result.fileName;
        currentSheets = result.sheets;
        showHeaderInput(result.sheets);
      } else {
        showStatus(result.message, 'success');
        fileInput.value = '';
      }
    }
    
    function showHeaderInput(sheets) {
      // éš±è—æ‹–æ›³å€å¡Šå’Œæ¸…é™¤æŒ‰éˆ•
      document.getElementById('dropZone').style.display = 'none';
      document.querySelector('.button-container').style.display = 'none';
      
      var container = document.getElementById('headerInputContainer');
      container.innerHTML = '<h3>ğŸ“‹ è«‹æŒ‡å®šå„åˆ†é çš„æ¨™é¡Œåˆ—ä½ç½®</h3>';
      
      for (var i = 0; i < sheets.length; i++) {
        var sheet = sheets[i];
        var div = document.createElement('div');
        div.className = 'sheet-header-input';
        
        var html = '<h4>ğŸ“„ ' + escapeHtml(sheet.name) + '</h4>';
        var suggestedRow = sheet.suggestedHeaderRow || 1;
        html += '<label>æ¨™é¡Œåˆ—åœ¨ç¬¬å¹¾åˆ—ï¼Ÿï¼ˆç³»çµ±å»ºè­°ï¼šç¬¬ ' + suggestedRow + ' åˆ—ï¼‰<input type="number" id="headerRow' + i + '" value="' + suggestedRow + '" min="1" max="100"></label>';
        html += '<table class="preview-table"><thead><tr><th>åˆ—</th>';
        
        if (sheet.preview.length > 0) {
          for (var j = 0; j < Math.min(10, sheet.preview[0].length); j++) {
            html += '<th>æ¬„' + (j + 1) + '</th>';
          }
        }
        
        html += '</tr></thead><tbody>';
        
        for (var r = 0; r < sheet.preview.length; r++) {
          var isHeaderRow = (r + 1) === suggestedRow;
          var rowClass = isHeaderRow ? ' style="background: #fff3e0; border: 2px solid #ff9800;"' : '';
          html += '<tr' + rowClass + '><td><strong>' + (r + 1) + (isHeaderRow ? ' ğŸ‘ˆ' : '') + '</strong></td>';
          for (var c = 0; c < Math.min(10, sheet.preview[r].length); c++) {
            var cellValue = sheet.preview[r][c] === null || sheet.preview[r][c] === undefined ? '' : sheet.preview[r][c];
            html += '<td>' + escapeHtml(String(cellValue)) + '</td>';
          }
          html += '</tr>';
        }
        
        html += '</tbody></table>';
        div.innerHTML = html;
        container.appendChild(div);
      }
      
      var confirmBtn = document.createElement('button');
      confirmBtn.className = 'confirm-btn';
      confirmBtn.innerHTML = '<span>âœ“ ç¢ºèªä¸¦ç¹¼çºŒåŒ¯å…¥</span>';
      confirmBtn.onclick = confirmHeaders;
      container.appendChild(confirmBtn);
      
      container.style.display = 'block';
    }
    
    function confirmHeaders() {
      var headerRows = [];
      
      for (var i = 0; i < currentSheets.length; i++) {
        var input = document.getElementById('headerRow' + i);
        var value = parseInt(input.value);
        
        if (isNaN(value) || value < 1) {
          showStatus('è«‹ç‚º "' + currentSheets[i].name + '" è¼¸å…¥æœ‰æ•ˆçš„åˆ—æ•¸', 'error');
          return;
        }
        
        headerRows.push(value);
      }
      
      showLoading('è™•ç†è³‡æ–™ä¸­...');
      document.getElementById('headerInputContainer').style.display = 'none';
      
      google.script.run
        .withSuccessHandler(onFinalImportSuccess)
        .withFailureHandler(onError)
        .handleImportWithHeaders(headerRows);
    }
    
    function onFinalImportSuccess(result) {
      hideLoading();
      
      if (result.success) {
        showStatus(result.message, 'success');
        document.getElementById('fileInput').value = '';
        
        // é‡æ–°é¡¯ç¤ºæ‹–æ›³å€å¡Šå’Œæ¸…é™¤æŒ‰éˆ•
        document.getElementById('dropZone').style.display = 'block';
        document.querySelector('.button-container').style.display = 'flex';
      } else {
        showStatus(result.message, 'error');
        
        // éŒ¯èª¤æ™‚ä¹Ÿé‡æ–°é¡¯ç¤º
        document.getElementById('dropZone').style.display = 'block';
        document.querySelector('.button-container').style.display = 'flex';
      }
    }
    
    function clearData() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;
      
      showLoading('æ¸…é™¤è³‡æ–™ä¸­...');
      
      google.script.run
        .withSuccessHandler(onClearSuccess)
        .withFailureHandler(onError)
        .handleClear();
    }
    
    function onClearSuccess(result) {
      hideLoading();
      
      if (result.success) {
        showStatus(result.message, 'success');
      } else {
        showStatus(result.message, 'error');
      }
    }
    
    function onError(error) {
      hideLoading();
      showStatus('ç™¼ç”ŸéŒ¯èª¤: ' + error.message, 'error');
    }
    
    function showStatus(message, type) {
      var status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
      
      setTimeout(function() {
        status.style.display = 'none';
      }, 8000);
    }
    
    function showLoading(text) {
      document.getElementById('loadingText').textContent = text || 'è™•ç†ä¸­...';
      document.getElementById('loading').style.display = 'block';
      var buttons = document.querySelectorAll('button');
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].disabled = true;
        buttons[i].style.opacity = '0.6';
        buttons[i].style.cursor = 'not-allowed';
      }
      dropZone.style.pointerEvents = 'none';
      dropZone.style.opacity = '0.6';
    }
    
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      var buttons = document.querySelectorAll('button');
      for (var i = 0; i < buttons.length; i++) {
        buttons[i].disabled = false;
        buttons[i].style.opacity = '1';
        buttons[i].style.cursor = 'pointer';
      }
      dropZone.style.pointerEvents = 'auto';
      dropZone.style.opacity = '1';
    }
    
    function escapeHtml(text) {
      var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
    }
  </script>
</body>
</html>
